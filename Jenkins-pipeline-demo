pipeline {

    agent any
 
    environment {

        JMETER_HOME = 'C:\\jmeter\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3' // <-- change this to your JMeter installation path

        RESULTS_DIR = 'jmeter-results-github'

    }
 
    stages {

       stage('Checkout') {
    steps {
        echo 'Checking out code from Git (main branch)...'
        git url: 'https://github.com/VinodhaRavi/Jenkins-pipeline-demo.git',
            branch: 'main'
    }
}

 
        stage('Run JMeter Tests') {

            steps {

                echo "Running JMeter test plan..."

                // Make sure results directory exists

                bat "if not exist %RESULTS_DIR% mkdir %RESULTS_DIR%"

                // Run JMeter in non-GUI mode

                bat """

                %JMETER_HOME%\\bin\\jmeter.bat -n -t "C:\\Users\\vravi2\\Documents\\Training\\Loadrunner_Exp\\Recorded Script\\SCR02_loadrunnertips2.jmx" -l "C:\\Users\\vravi2\\Documents\\Training\\Loadrunner_Exp\\Replay Log\\loadrunnertips1.jtl" -e -o "C:\\Users\\vravi2\\Documents\\Training\\Loadrunner_Exp\\Replay Log"

                """

            }

        }
 
        stage('Archive Results') {

            steps {

                echo "Archiving JMeter reports..."

                archiveArtifacts artifacts: "${RESULTS_DIR}/**", allowEmptyArchive: true

            }

        }
 
        stage('Publish HTML Report') {

            steps {

                script {

                    // Check if HTML Publisher plugin is installed

                    if (fileExists("${RESULTS_DIR}/report/index.html")) {

                        publishHTML (target: [

                            allowMissing: false,

                            alwaysLinkToLastBuild: true,

                            keepAll: true,

                            reportDir: "${RESULTS_DIR}/report",

                            reportFiles: 'index.html',

                            reportName: 'JMeter Test Report'

                        ])

                    } else {

                        echo "HTML report not found, skipping HTML publish."

                    }

                }

            }

        }

    }
 
    post {

        always {

            echo "JMeter pipeline finished!"

        }

    }

}
 
